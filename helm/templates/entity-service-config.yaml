apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.entityServiceConfig.name }}
  labels:
    release: {{ .Release.Name }}
data:
  application.conf: |-
    entity.service.config = {
      entity-service {
        dataStoreType = {{ .Values.entityServiceConfig.dataStoreType }}
        {{- if eq .Values.entityServiceConfig.dataStoreType "mongo" }}
        mongo {
          {{- if .Values.entityServiceConfig.data.mongoUrl }}
          url = {{ .Values.entityServiceConfig.data.mongoUrl | quote }}
          {{- else }}
          host = {{ .Values.entityServiceConfig.data.mongoHost }}
          {{- end }}
        }
        {{ else if eq .Values.entityServiceConfig.dataStoreType "postgres" }}
        postgres {
          {{- if .Values.entityServiceConfig.postgres.url }}
          url={{ .Values.entityServiceConfig.postgres.url | quote }}
          {{- else }}
          host={{ .Values.entityServiceConfig.postgres.host }}
          port={{ .Values.entityServiceConfig.postgres.port }}
          {{- end }}
          {{- if .Values.entityServiceConfig.postgres.database }}
          database= {{ .Values.entityServiceConfig.postgres.database }}
          {{- end }}
          {{- if and .Values.entityServiceConfig.postgres.user .Values.entityServiceConfig.postgres.password }}
          user={{ .Values.entityServiceConfig.postgres.user }}
          password={{ .Values.entityServiceConfig.postgres.password }}
          {{- end }}
        }
        {{- end }}
      }
    }
  {{- if .Values.attributes }}
    entity.service.attributeMap = [
  {{- range $i, $v := .Values.attributes }}
  {{- if gt $i 0 }},{{- end}}
      {
        "scope": {{ $v.scope | quote }},
        "name": {{ $v.name | quote }},
        "subDocPath": {{ $v.subDocPath | quote }}
      }
  {{- end }}
  {{- range $i, $v := .Values.extraAttributes }}
  {{- if or ($.Values.attributes) (gt $i 0) }},{{- end}}
      {
        "scope": {{ $v.scope | quote }},
        "name": {{ $v.name | quote }},
        "subDocPath": {{ $v.subDocPath | quote }}
      }
  {{- end }}
    ]
  {{- end -}}
